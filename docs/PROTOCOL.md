

# ğŸŒ LLM-AVF åŒå‘é€šè®¯åè®® (Protocol Specification)

æœ¬åè®®å®šä¹‰äº† **AVF å¼•æ“**ä¸ **LLM å†³ç­–æœåŠ¡**ä¹‹é—´é€šè¿‡ WebSocket (æ¨è) æˆ–å…¶ä»– API æ¥å£è¿›è¡Œå®æ—¶æ•°æ®äº¤æ¢çš„æ ‡å‡†æ ¼å¼ã€‚

## â… . é€šç”¨å°è£…å±‚ (Message Envelope)

æ‰€æœ‰æ¶ˆæ¯éƒ½å¿…é¡»åŒ…è£¹åœ¨ä¸€ä¸ªé€šç”¨ JSON ç»“æ„ä¸­ï¼Œç”¨äºè·¯ç”±ã€ä¼šè¯ç®¡ç†å’Œç±»å‹è¯†åˆ«ã€‚

| å­—æ®µåç§° | ç±»å‹ | ç¤ºä¾‹ | æè¿° |
| :--- | :--- | :--- | :--- |
| `msg_id` | String | `"req_123abc"` | **å…¨å±€å”¯ä¸€ ID**ã€‚ç”¨äºè¯·æ±‚/å“åº”åŒ¹é…å’Œè·Ÿè¸ªã€‚ |
| `session_id` | String | `"sim_village_01"` | æ‰€å±çš„**è™šæ‹Ÿä¸–ç•Œ/æ¨¡æ‹Ÿä¼šè¯**æ ‡è¯†ç¬¦ã€‚ |
| `timestamp` | Number | `1712345678901` | æ¶ˆæ¯ç”Ÿæˆçš„æ—¶é—´æˆ³ (æ¯«ç§’)ã€‚ |
| `direction` | Enum | `"to_llm"` | æ¶ˆæ¯æ–¹å‘ï¼š`to_llm` (æ„ŸçŸ¥è¾“å…¥) æˆ– `from_llm` (è¡Œä¸ºå“åº”)ã€‚ |
| `type` | Enum | `"perception"` | æ¶ˆæ¯ç±»å‹ï¼šå®šä¹‰ `payload` å†…å®¹çš„ç»“æ„ã€‚è§ä¸‹æ–‡ã€‚ |
| `payload` | Object | `{...}` | **æ ¸å¿ƒå†…å®¹**ã€‚ç»“æ„ç”± `type` å­—æ®µå†³å®šã€‚ |

### æ¶ˆæ¯ç±»å‹ (`type`) å®šä¹‰

| Type | Direction | æè¿° |
| :--- | :--- | :--- |
| `perception` | `to_llm` | AVF å‘é€ç»™ Agent çš„**ä¸–ç•ŒçŠ¶æ€æ„ŸçŸ¥æ•°æ®**ï¼Œè¯·æ±‚å†³ç­–ã€‚ |
| `action_response` | `from_llm` | LLM è¿”å›çš„**å†³ç­–ç»“æœ**ï¼ŒåŒ…å«ä¸€ç³»åˆ—å¾…æ‰§è¡ŒåŠ¨ä½œã€‚ |
| `execution_feedback` | `to_llm` | AVF è¿”å›çš„**åŠ¨ä½œæ‰§è¡Œç»“æœåé¦ˆ**ï¼Œç”¨äº Agent å­¦ä¹ å’Œä¿®æ­£ã€‚ |

-----

## â…¡. æ¶ˆæ¯ç»“æ„è¯¦æƒ…

### A. æ„ŸçŸ¥è¾“å…¥ (Perception Input)

**ç±»å‹:** `perception` | **æ–¹å‘:** `to_llm`

å¼•æ“å°† Agent åœ¨å½“å‰å¸§æ‰€èƒ½æ„ŸçŸ¥åˆ°çš„æ‰€æœ‰ä¿¡æ¯ç»“æ„åŒ–åå‘é€ç»™ LLMã€‚

```json
{
  "type": "perception",
  "payload": {
    "agent_id": "agent_123",
    "agent_name": "tony",
    "role": "PM",
    "scene_summary": "ç°åœ¨åŠå…¬å®¤å¿™äºé¡¹ç›®ï¼Œæ°”æ°›ç•¥æ˜¾ç´§å¼ ã€‚",
    "sensory_input": {
      "vision": [
        { "entity": "Alex", "pos": [1, 0], "distance": 1, "status": "working" }
      ]
    },
    "memory": [], // å¾…è¡¥å……ï¼šçŸ­æœŸ/å…³é”®è®°å¿†æ‘˜è¦
    "relationships": [], // å¾…è¡¥å……ï¼šä¸å…³é”®è§’è‰²çš„å…³ç³»æ‘˜è¦
    "tasks": [
      { "task_id": "task_id_01", "name": "æ ¸å¿ƒé¡¹ç›®æ¨è¿›", "status": "in_progress", "due_date": "2025-12-31" }
    ],
    "available_actions": [
      "move_to(location)",
      "say_speech(text, tone?)",
      // ... æ›´å¤šå¯ç”¨åŠ¨ä½œåˆ—è¡¨
    ]
  }
}
```

| å­—æ®µåç§° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `agent_id` | String | å½“å‰è¯·æ±‚å†³ç­–çš„ Agent å”¯ä¸€æ ‡è¯†ç¬¦ã€‚ |
| `scene_summary` | String | å½“å‰ç¯å¢ƒçš„**è‡ªç„¶è¯­è¨€**é«˜çº§æ‘˜è¦ï¼ˆä¾‹å¦‚ï¼šæ‹¥æŒ¤çš„é›†å¸‚ã€å®‰é™çš„å›¾ä¹¦é¦†ï¼‰ã€‚ |
| `sensory_input` | Object | ç»“æ„åŒ–æ„ŸçŸ¥æ•°æ®ã€‚`vision` åˆ—è¡¨åŒ…å«è§†é‡å†…çš„å®ä½“ä¿¡æ¯ã€‚ |
| `memory` | Array | Agent çš„**çŸ­æœŸä¸Šä¸‹æ–‡å’Œå…³é”®è®°å¿†**æ‘˜è¦ï¼ˆä¾‹å¦‚ï¼šæœ€è¿‘å‘ç”Ÿçš„äº‹ä»¶ï¼‰ã€‚ |
| `relationships` | Array | Agent ä¸è§†é‡å†…/å…³é”®è§’è‰²çš„å…³ç³»çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼šå¥½å‹åº¦ã€ä¿¡ä»»å€¼ï¼‰ã€‚ |
| `tasks` | Array | å½“å‰ Agent æ­£åœ¨æ‰§è¡Œæˆ–å¾…å¤„ç†çš„ä»»åŠ¡åˆ—è¡¨ã€‚ |
| `available_actions` | Array | Agent **å½“å‰çŠ¶æ€ä¸‹**å¯æ‰§è¡Œçš„åŠ¨ä½œåˆ—è¡¨ï¼Œä½œä¸º LLM çš„è¡ŒåŠ¨çº¦æŸã€‚ |

### B. è¡Œä¸ºå“åº” (Action Response)

**ç±»å‹:** `action_response` | **æ–¹å‘:** `from_llm`

LLM å¯¹æ„ŸçŸ¥è¾“å…¥åšå‡ºçš„å†³ç­–ã€‚åŒ…å«æ„å›¾å’Œä¸€ç³»åˆ—æŒ‰é¡ºåºæ‰§è¡Œçš„åŠ¨ä½œã€‚

```json
{
  "type": "action_response",
  "payload": {
    "agent_id": "agent_123",
    "response_to": "req_123abc",
    "intention": "è¯¢é—®é¡¹ç›®è¿›å±•å¹¶è¡¨ç¤ºæ”¯æŒ",
    "actions": [
      { "type": "move_to", "location": "Alex's Desk" },
      { "type": "ask_question", "target": "Alex", "question": "é¡¹ç›®è¿›å±•æ€ä¹ˆæ ·äº†ï¼Ÿéœ€è¦å¸®å¿™å—ï¼Ÿ" }
    ],
    "memory_update": "å·²å†³å®šè¯¢é—®Alexé¡¹ç›®è¿›å±•å¹¶æä¾›å¸®åŠ©ï¼Œè¿™æœ‰åŠ©äºå‡è½»æˆ‘çš„å‹åŠ›ã€‚",
    "internal_thought": "Alexçœ‹èµ·æ¥æœ‰ç‚¹ç„¦è™‘ï¼Œæˆ‘åº”è¯¥ä¸»åŠ¨æä¾›å¸®åŠ©ï¼Œä»¥ç¬¦åˆPMçš„è§’è‰²è®¾å®šã€‚"
  }
}
```

| å­—æ®µåç§° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `response_to` | String | å¿…é¡»åŒ¹é…è¯·æ±‚å®ƒçš„ **`msg_id`**ï¼Œç”¨äºè¯·æ±‚/å“åº”åŒ¹é…ã€‚ |
| `intention` | String | Agent é‡‡å–è¡ŒåŠ¨çš„**é«˜å±‚æ¬¡ç›®çš„**ï¼ˆè‡ªç„¶è¯­è¨€ï¼‰ã€‚ |
| `actions` | Array of Object | **æ ¸å¿ƒ**ã€‚ Agent å†³å®šè¦æ‰§è¡Œçš„åŠ¨ä½œåºåˆ—ã€‚ |
| `memory_update` | String | **é•¿æœŸè®°å¿†**æ›´æ–°ç‰‡æ®µã€‚Engine å°†æ­¤ä¿¡æ¯å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“ã€‚ |
| `internal_thought` | String | LLM çš„**å†…éƒ¨æ¨ç†è¿‡ç¨‹**ã€‚ç”¨äºè°ƒè¯•å’Œè¡Œä¸ºåˆ†æï¼Œä¸å½±å“æ‰§è¡Œã€‚ |

#### åŠ¨ä½œç±»å‹ (Action Schema)

åŠ¨ä½œæ˜¯ LLM è¾“å‡ºçš„ç»“æ„åŒ–æŒ‡ä»¤ï¼ŒAVF å¼•æ“è´Ÿè´£è§£æå’Œæ‰§è¡Œã€‚

| åŠ¨ä½œç±»å‹ (`type`) | å…³é”®å‚æ•° | æè¿° |
| :--- | :--- | :--- |
| `say_speech` | `text`, `target?`, `tone?` | è§’è‰²è¯´è¯ã€‚`target` å¯æŒ‡å®šå¯¹è±¡ï¼Œ`tone` å¯å½±å“è¯­éŸ³åˆæˆã€‚ |
| `emote` | `expression`, `duration?` | è¡¨æƒ…/è‚¢ä½“åŠ¨ä½œï¼ˆå¦‚ `wave`, `frown`ï¼‰ã€‚ |
| `move_to` | `location`, `speed?` | ç§»åŠ¨åˆ°ç‰¹å®šçš„åæ ‡ (`x`, `y`) æˆ–åœ°æ ‡åç§° (`location_name`)ã€‚ |
| `follow` | `target_id` | è·ŸéšæŸä¸ªå®ä½“ï¼ŒæŒç»­æ›´æ–°ç›®æ ‡ä½ç½®ã€‚ |
| `use_item` | `item_id`, `on?` | å¯¹è‡ªèº«æˆ–ç›®æ ‡ä½¿ç”¨ç‰©å“ï¼ˆå¦‚ï¼š`use_item("coffee_mug", "self")`ï¼‰ã€‚ |
| `give_item` | `item_id`, `target` | å°†ç‰©å“ç»™äºˆå¦ä¸€ä¸ª Agentã€‚ |
| `start_dialogue` | `with`, `topic?` | å¼€å¯ä¸€ä¸ªåŒå‘å¯¹è¯æµç¨‹ã€‚ |
| `investigate` | `source` | ä¸»åŠ¨æŸ¥çœ‹æˆ–è°ƒæŸ¥å¯ç–‘äº‹ä»¶/ç‰©ä½“ã€‚ |
| `play_animation` | `anim_name`, `loop?` | æ’­æ”¾é¢„è®¾åŠ¨ç”»ï¼ˆå¦‚ï¼šåä¸‹ã€è·³èˆï¼‰ã€‚ |
| `trigger_event` | `event_id`, `params?` | è§¦å‘ç¯å¢ƒæˆ–å‰§æƒ…äº‹ä»¶ï¼ˆéœ€ Engine æˆæƒï¼‰ã€‚ |
| `wait` | `duration` | ä¿æŒå½“å‰çŠ¶æ€å¹¶ç­‰å¾…æŒ‡å®šæ—¶é—´ï¼ˆç§’æˆ–å¸§ï¼‰ã€‚ |

### C. åŠ¨ä½œæ‰§è¡Œåé¦ˆ (Execution Feedback)

**ç±»å‹:** `execution_feedback` | **æ–¹å‘:** `to_llm`

AVF å¼•æ“å°†æ‰§è¡ŒåŠ¨ä½œçš„ç»“æœåé¦ˆç»™ Agentï¼Œç”¨äºè°ƒæ•´åç»­å†³ç­–ã€‚

```json
{
  "type": "execution_feedback",
  "payload": {
    "original_request": "req_123abc",
    "action_index": 0,
    "action_type": "move_to",
    "result": "failed",
    "outcome_desc": "æ— æ³•ç§»åŠ¨ï¼šè·¯å¾„è¢«å¦ä¸€ä¸ªAgentï¼ˆBobï¼‰é˜»å¡ã€‚",
    "player_reaction": "Bobå¯¹Tonyçš„è¯·æ±‚ç½®ä¹‹ä¸ç†ã€‚",
    "side_effects": "Tonyçš„æƒ…ç»ªç•¥å¾®ä½è½ (mood:-5)ã€‚"
  }
}
```

| å­—æ®µåç§° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `original_request` | String | å¯¹åº” LLM å‘é€çš„ `action_response` çš„ `response_to` å­—æ®µã€‚ |
| `action_index` | Number | åœ¨åŸåŠ¨ä½œåºåˆ— (Actions Array) ä¸­çš„ç´¢å¼•ä½ç½®ã€‚ |
| `action_type` | String | åŠ¨ä½œçš„ç±»å‹ï¼ˆå¦‚ `say_speech`ï¼‰ã€‚ |
| `result` | Enum | **åŠ¨ä½œç»“æœ**ï¼š`success` / `failed` / `interrupted` (è¢«æ›´é«˜ä¼˜å…ˆçº§äº‹ä»¶æ‰“æ–­)ã€‚ |
| `outcome_desc` | String | åŠ¨ä½œæ‰§è¡Œçš„**è‡ªç„¶è¯­è¨€ç»“æœæè¿°**ï¼Œå…³é”®çš„æ„ŸçŸ¥è¾“å…¥ã€‚ |
| `player_reaction` | String | **å¯é€‰**ã€‚ å¦‚æœåŠ¨ä½œæ¶‰åŠå…¶ä»– Agentï¼Œæè¿°å…¶ååº”ã€‚ |
| `side_effects` | String | **å¯é€‰**ã€‚åŠ¨ä½œå¯¹ç¯å¢ƒæˆ– Agent è‡ªèº«çŠ¶æ€ï¼ˆå¦‚æƒ…ç»ªã€ç‰©å“ï¼‰é€ æˆçš„å‰¯ä½œç”¨ã€‚ |

-----

## â…¢. åè®®ç‰¹æ€§æ€»ç»“

| ç‰¹æ€§ | ç›®çš„/å®ç°æ–¹å¼ |
| :--- | :--- |
| **è¯­ä¹‰ä¸°å¯Œ** | é€šè¿‡ `scene_summary`ã€`intention` å’Œ `outcome_desc` æä¾›é«˜è´¨é‡çš„è‡ªç„¶è¯­è¨€ä¸Šä¸‹æ–‡ã€‚ |
| **å¯è§£ææ€§å¼º** | é‡‡ç”¨ JSON Schema æ ‡å‡†åŒ–æ‰€æœ‰å…³é”®å­—æ®µï¼Œç¡®ä¿æ•°æ®çš„è‡ªåŠ¨åŒ–å¤„ç†ã€‚ |
| **æ”¯æŒé•¿æœŸè®°å¿†** | å¼•å…¥ `memory` å­—æ®µä¼ é€’å…³é”®æ‘˜è¦ï¼Œ`memory_update` ç”¨äºç§¯ç´¯æ–°çŸ¥è¯†ã€‚ |
| **æ”¯æŒå¤æ‚è¡Œä¸º** | `actions` å­—æ®µæ”¯æŒ**å¤šåŠ¨ä½œåºåˆ—**ï¼Œ`execution_feedback` æ”¯æŒç»†ç²’åº¦çš„æ¡ä»¶åé¦ˆã€‚ |
| **æ˜“äºé›†æˆ** | æ ‡å‡†åŒ–çš„ I/O æ ¼å¼æ”¯æŒå¿«é€Ÿé€‚é… **Qwen**ã€**Deepseek** æˆ–æœ¬åœ°éƒ¨ç½²çš„ **Ollama** æ¨¡å‹ã€‚ |
| **å®æ—¶æ€§** | æ¨èä½¿ç”¨ WebSocket ä¿è¯ä½å»¶è¿Ÿçš„åŒå‘é€šä¿¡ã€‚ |